
<%# We add a data-user-id so the browser knows who sent this %>
<div class="message-row" data-sender-id="<%= message.user_id %>" style="display: flex; justify-content: flex-start;">
  <div class="message-box" 
       style="max-width: 75%; padding: 12px 18px; border: 3px solid black; font-weight: 600; background: #fff; color: #000; box-shadow: 4px 4px 0px black;">
    <p style="margin: 0;"><%= message.body %></p>
    <div style="font-size: 0.7rem; margin-top: 5px; opacity: 0.6; text-align: right;">
      <%= message.created_at.strftime("%I:%M %p") %>
    </div>
  </div>
</div>

<script>
  function scrollToBottom() {
    const chatWindow = document.getElementById('chat-window');
    if (chatWindow) {
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }
  }

  // 1. Scroll when you first open the page
  document.addEventListener("turbo:load", scrollToBottom);

  // 2. Clear input after YOU send a message
  document.addEventListener("turbo:submit-end", function(event) {
    const messageForm = document.getElementById("message_form");
    if (event.target === messageForm && event.detail.success) {
      messageForm.reset();
      setTimeout(scrollToBottom, 50); // Small delay to let the message render
    }
  });

  // 3. Scroll when a message arrives via real-time (Turbo Stream)
  // This listener catches the broadcast from the other user
  document.addEventListener("turbo:before-stream-render", function() {
    setTimeout(scrollToBottom, 50);
  });
</script>